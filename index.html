<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Cosmic Map Engine</title>
  <!-- styles unchanged from previous index; keep exactly as you have -->
  <style>
    html, body {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      background: #020617;
      color: #e5e7eb;
    }
    #app {
      position: relative;
      width: 100%;
      height: 100%;
    }
    #map {
      position: absolute;
      inset: 0;
      overflow: hidden;
      cursor: grab;
      background: radial-gradient(circle at top, #0f172a 0, #020617 55%);
    }
    #map.dragging {
      cursor: grabbing;
    }
    .tile-layer {
      position: absolute;
      top: 50%;
      left: 50%;
      transform-origin: 0 0;
    }
    .tile {
      position: absolute;
      image-rendering: auto;
      transition: opacity 0.25s ease-out;
      opacity: 0;
    }
    .tile.loaded {
      opacity: 1;
    }
    .marker-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
    }
    .marker {
      position: absolute;
      width: 18px;
      height: 18px;
      border-radius: 999px;
      border: 2px solid #0ea5e9;
      background: #38bdf8;
      box-shadow: 0 0 12px rgba(56, 189, 248, 0.9);
      transform: translate(-50%, -50%) scale(1);
      pointer-events: auto;
      cursor: pointer;
      transition: transform 0.15s ease-out, box-shadow 0.2s ease-out;
    }
    .marker.selected {
      transform: translate(-50%, -50%) scale(1.3);
      box-shadow: 0 0 20px rgba(129, 140, 248, 0.95);
      border-color: #a855f7;
      background: #6366f1;
    }
    .ui-panel {
      position: absolute;
      top: 12px;
      left: 12px;
      padding: 10px 12px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.88);
      border: 1px solid rgba(148, 163, 184, 0.35);
      backdrop-filter: blur(16px);
      display: flex;
      gap: 8px;
      align-items: center;
      z-index: 20;
    }
    .ui-button {
      border: none;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(30, 64, 175, 0.9);
      color: #e5e7eb;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
      transition: background 0.15s ease-out, transform 0.1s ease-out, box-shadow 0.15s;
    }
    .ui-button:hover {
      background: rgba(79, 70, 229, 0.95);
      transform: translateY(-1px);
      box-shadow: 0 0 16px rgba(129, 140, 248, 0.8);
    }
    .ui-button:active {
      transform: translateY(0);
      box-shadow: 0 0 10px rgba(59, 130, 246, 0.6);
    }
    .ui-badge {
      font-size: 11px;
      color: #9ca3af;
    }
    #streetview-panel {
      position: absolute;
      right: 12px;
      bottom: 12px;
      width: 360px;
      height: 220px;
      border-radius: 18px;
      overflow: hidden;
      background: radial-gradient(circle at top, #020617 0, #0b1120 50%, #000 100%);
      border: 1px solid rgba(148, 163, 184, 0.4);
      box-shadow: 0 18px 45px rgba(15, 23, 42, 0.95);
      display: none;
      flex-direction: column;
      z-index: 25;
      backdrop-filter: blur(18px);
    }
    #streetview-panel.active {
      display: flex;
    }
    #streetview-header {
      padding: 8px 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 12px;
      color: #e5e7eb;
      background: linear-gradient(to right, rgba(37, 99, 235, 0.35), rgba(147, 51, 234, 0.3));
    }
    #streetview-close {
      border: none;
      background: transparent;
      color: #cbd5f5;
      cursor: pointer;
      font-size: 14px;
    }
    #streetview-content {
      flex: 1;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #94a3b8;
      font-size: 12px;
      padding: 0;
      text-align: center;
      background: #000;
    }
    #streetview-canvas {
      width: 100%;
      height: 100%;
      display: block;
      cursor: grab;
    }
    #streetview-pegman {
      width: 24px;
      height: 24px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 30%, #facc15 0, #f97316 40%, #b91c1c 100%);
      border: 2px solid #fbbf24;
      box-shadow: 0 0 16px rgba(250, 204, 21, 0.9);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      color: #111827;
      font-size: 14px;
      cursor: grab;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 15;
    }
    #streetview-pegman.dragging {
      cursor: grabbing;
      transform: translate(-50%, -50%) scale(1.1);
    }
    #coords-label {
      position: absolute;
      bottom: 10px;
      left: 12px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15, 23, 42, 0.85);
      border: 1px solid rgba(148, 163, 184, 0.35);
      font-size: 11px;
      color: #9ca3af;
      z-index: 18;
      pointer-events: none;
      max-width: 60%;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="map">
      <div class="tile-layer" id="tile-layer"></div>
      <div class="marker-layer" id="marker-layer"></div>
      <div id="streetview-pegman" title="Drag onto map for street view">‚¨§</div>
      <div id="coords-label"></div>
    </div>

    <div class="ui-panel">
      <button class="ui-button" id="btn-reset">‚ü≥ Reset</button>
      <button class="ui-button" id="btn-toggle-streetview">üèô Street View</button>
      <button class="ui-button" id="btn-draw">‚úèÔ∏è Draw</button>
      <button class="ui-button" id="btn-radius">‚≠ï Radius</button>
      <button class="ui-button" id="btn-layers">‚ò∞ Layers</button>
      <span class="ui-badge" id="badge-status">Map: ready ¬∑ local save enabled</span>
    </div>

    <div id="streetview-panel">
      <div id="streetview-header">
        <span>Street View</span>
        <button id="streetview-close">‚úï</button>
      </div>
      <div id="streetview-content">
        <canvas id="streetview-canvas"></canvas>
      </div>
    </div>

    <div id="perf-panel"
         style="position:absolute;top:12px;right:12px;padding:6px 10px;border-radius:999px;
                background:rgba(15,23,42,0.9);border:1px solid rgba(148,163,184,0.4);
                font-size:11px;color:#9ca3af;z-index:30;"></div>

    <div id="layer-panel"
         style="position:absolute;top:60px;right:12px;padding:8px 10px;border-radius:12px;
                background:rgba(15,23,42,0.95);border:1px solid rgba(148,163,184,0.4);
                font-size:12px;color:#e5e7eb;z-index:28;display:none;"></div>
  </div>

  <script type="module">
    import { StorageEngine } from './modules/storageEngine.js';
    import { TileCacheEngine } from './modules/tileCacheEngine.js';
    import { MapCore } from './modules/mapCore.js';
    import { MarkerEngine } from './modules/markerEngine.js';
    import { StreetViewShell } from './modules/streetViewShell.js';
    import { initUIOverlay } from './modules/uiOverlay.js';

    import { PopupEngine } from './modules/popupEngine.js';
    import { DrawingEngine } from './modules/drawingEngine.js';
    import { RadiusTool } from './modules/radiusTool.js';
    import { LayerManager } from './modules/layerManager.js';
    import { PerfMonitor } from './modules/perfMonitor.js';

    const MAP_CONFIG = {
      tileUrlTemplate: 'https://tile.openstreetmap.org/{z}/{x}/{y}.png',
      minZoom: 2,
      maxZoom: 20,
      overfetchTiles: 1,
      initialCenter: { lat: 33.7490, lng: -84.3880 }, // Atlanta
      initialZoom: 12,
      storageKey: 'cosmicMapState_v1',
      tileCacheName: 'cosmicTileCache_v1',
      offlineTilesEnabled: true
    };

    // Simple pano registry: you swap in your own 360s here.
    // key: string (custom id), each has lat,lng and local or remote image URL.
    const PANO_REGISTRY = [
      {
        id: 'atlanta-demo',
        lat: 33.7490,
        lng: -84.3880,
        imageUrl: './panos/atlanta_360_equirect.jpg'
      }
      // add more { id, lat, lng, imageUrl } entries as needed
    ];

    window.addEventListener('DOMContentLoaded', () => {
      const mapEl = document.getElementById('map');
      const tileLayer = document.getElementById('tile-layer');
      const markerLayer = document.getElementById('marker-layer');
      const coordsLabel = document.getElementById('coords-label');
      const perfPanel = document.getElementById('perf-panel');
      const layerPanel = document.getElementById('layer-panel');

      const storage = new StorageEngine(MAP_CONFIG.storageKey);
      const tileCache = MAP_CONFIG.offlineTilesEnabled
        ? new TileCacheEngine(MAP_CONFIG.tileCacheName)
        : null;

      const mapCore = new MapCore(mapEl, tileLayer, MAP_CONFIG, storage, tileCache);
      const markerEngine = new MarkerEngine(mapCore, markerLayer, storage);
      const streetViewShell = new StreetViewShell(mapCore, PANO_REGISTRY);

      const popupEngine = new PopupEngine(mapCore);
      const drawingEngine = new DrawingEngine(mapCore, popupEngine);
      const radiusTool = new RadiusTool(mapCore, markerEngine, popupEngine);
      const layerManager = new LayerManager(mapCore, markerEngine, drawingEngine, radiusTool, layerPanel);
      const perfMonitor = new PerfMonitor(mapCore, perfPanel);

      initUIOverlay({
        mapCore,
        markerEngine,
        storage,
        streetViewShell,
        coordsLabel,
        popupEngine,
        drawingEngine,
        radiusTool,
        layerManager,
        perfMonitor
      });
    });
  </script>
</body>
</html>
